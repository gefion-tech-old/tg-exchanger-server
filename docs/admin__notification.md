## Notification

### Notification Type

Существует ТРИ типа уведомлений

- **854** — уведомлений о верификации карты
- **855** — уведомлений о произошедшем сбое операции обмена

- **900** — уведомлений о запросе тех поддержки от пользователя

**Почему именно такие статусы?**

Так как создание уведомления — это публичная точка доступа(создается из бота), статусы по типу 1, 2, 3 слишком легко угадываются.
Статусы в диапазоне от 200 - 500 занимают статусы HTTP ответов, и чтобы не путаться было принято решение использовать статусы ближе к 1000.

<hr>

### Notification Status

Существует ТРИ вида статуса уведомления:

- **1** — новое(непрочитанное) уведомление;
- **2** — уведомление которое сейчас просматривает менеджер;
- **3** — обработанное уведомление;

Статус `2` необходим для того чтобы не было конфликта подтверждения, когда один менеджер открыл заявку, одобрил, а второй отказал. 
Поэтому при открытие любого уведомления необходимо отправлять на сервер [update](#update-status) запрос, дабы уведомить систему о текущем положении дел.

Если в админке уведомление имеет статус `2` оно должно быть заблокировано и не открываться по клику на него.

**Сценарий 1:**
Менеджер открыл уведомление (в момент открытия оно блокируется для других менеджеров) и *одобрил* его, оно автоматически фиксируется как обработанное и ему присваивается статус **3**. 

**Сценарий 2:**
Менеджер открыл уведомление (в момент открытия оно блокируется для других менеджеров) и *не одобрил* его, к примеру нажал на кнопку закрыть или вообще закрыл браузер. Алгоритм работы таков: если клиент закрыл окно через кнопку ОТМЕНИТЬ, то в момент клика на сервер необходимо отправить запрос на обновления статуса (вернуть на статус **1**), если человек по какой-то причине не закрыл окно, то через 3 минуты, на фоне автоматически должен отправиться запрос на обновление статуса а у пользователя автоматически перезагрузится страница. 

<hr>

### Create

При создании уведомления в NSQ записывается очередь сообщений которая будет отправленна всем менеджерам.


- **[POST]** `/api/v1/admin/notification` — создать новое уведомление

#### 854

Все изображения полученные от пользователя сохраняются в папку `tmp`

***Request***

```json
{
    "type": 854,
    "meta_data": {
        "card_verification": {
            "code": 245335,
            "user_card": "5559494130410854",
            "img_path": "tmp/I0HuKc_2021-12-12T16:33:29.26685161.png"
        }
    },
    "user": {
        "chat_id": 3546223,
        "username": "I0HuKc"
    }

```

***Response***

```json
{
    "id": 8,
    "type": 854,
    "status": 1,
    "meta_data": {
        "code": 245335,
        "user_card": "5559494130410854",
        "img_path": "tmp/I0HuKc_2021-12-12T16:33:29.26685161.png"
    },
    "user": {
        "chat_id": 3546223,
        "username": "I0HuKc"
    },
    "created_at": "2021-12-13T11:57:10.809798Z",
    "updated_at": "2021-12-13T11:57:10.809798Z"
}
```

<hr>

### Get Slice of Notifications

Получить срез нужного участка данных из БД `notifications`

- **[GET]** `/api/v1/admin/notifications?page=1&limit=15` — Получить нужную выборку записей 

API путь указан с значениями по умолчанию для параметров запроса, т.е. если явно не указать параметры и их значения для параметра `page` автоматически на сервере будет установленно значение **1**, для параметра `limit` значение **15**. 

Это сделано для того , чтобы при простом переходе по ссылке `/api/v1/admin/notifications` все выполнялось автоматически и не нужно было указывать длинную ссылку. 

***Header***

```json
{
    "Authorization": "Bearer <token>"
}
```

***Response***

```json
{
    "current_page": 1,
    "data": [],
    "last_page": 2,
    "limit": 15
}
```

<hr>

### Update Status

- **[PUT]** `/api/v1/admin/notification/:id` — обновить статус уведомления


***Header***

```json
{
    "Authorization": "Bearer <token>"
}
```


***Request***

```json
{
    "id": 2,
    "type": 854,
    "status": 2,
    "user": {
        "chat_id": 3546223,
        "username": "I0HuKc"
    }
}
```


***Response***

```json
{
    "id": 2,
    "type": 854,
    "status": 2,
    "meta_data": {
        "code": 691156,
        "user_card": "5559494130410854",
        "img_path": null
    },
    "user": {
        "chat_id": 524164407,
        "username": "I0HuKc"
    },
    "created_at": "2021-12-12T19:24:10.156095Z",
    "updated_at": "2021-12-13T10:16:59.499637Z"
}
```

<hr>

### Delete

- **[DELETE]** `/api/v1/admin/notification/:id` — удалить уведомление

***Header***

```json
{
    "Authorization": "Bearer <token>"
}
```


***Request***

```json
{
    "id": 2,
    "type": 854,
    "status": 2,
    "user": {
        "chat_id": 3546223,
        "username": "I0HuKc"
    }
}
```


***Response***

```json
{
    "id": 2,
    "type": 854,
    "status": 2,
    "meta_data": {
        "code": 691156,
        "user_card": "5559494130410854",
        "img_path": null
    },
    "user": {
        "chat_id": 524164407,
        "username": "I0HuKc"
    },
    "created_at": "2021-12-12T19:24:10.156095Z",
    "updated_at": "2021-12-13T10:16:59.499637Z"
}
```